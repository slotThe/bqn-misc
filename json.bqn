# Parsing a subset of JSON. The rules are:
#
# + Only positive integers.
# + Only ASCII in strings.
# + No constants.
# + Currently there is no input validation -- it better be valid!
#
# https://tony-zorman.com/posts/bqn-json.html

### Code

# 'Tokenise json' yields 'tokensâ€¿numbersâ€¿strings', where 'tokens' is a string
# of characters each representing a token -- with '"' for strings and '0' for
# numbers --, 'numbers' is a list of numbers in order of occurrence, and
# 'strings' is a list of strings in order of occurrence.
#
#     Tokenise "{""a"": 123, ""bcde"": [1,42,30]}"
# âŸ¨ "{"":0,"":[0,0,0]}" âŸ¨ 123 1 42 30 âŸ© âŸ¨ "a" "bcde" âŸ© âŸ©
Tokenise â† {
  e  â† Â»<`'\'=ğ•©                  # Escapes
  sb â† Â»âŠ¸< sâ† â‰ `(Â¬e)âˆ§ '"'=ğ•©      # String beginnings
  sr â† (1-Ëœ(s>sb)Ã—+`sb)âŠ”ğ•©        # Strings to return

  ex â† sâˆ¨ ğ•©âˆŠ@+9â€¿10â€¿13â€¿32         # Exclude whitespace and strings
  nb â† Â»âŠ¸< nâ† (Â¬ex)âˆ§ ğ•©âˆŠ'0'+â†•10   # Number beginnings
  nr â† â€¢ParseFloatÂ¨(1-ËœnÃ—+`nb)âŠ”ğ•© # Numbers to return

  ts â† sbâˆ¨(Â¬ex)âˆ§nbâˆ¨ğ•©âˆŠ"[]{},:"    # Tokens
  âŸ¨ts/ '0'Â¨âŒ¾(nbâŠ¸/) ğ•©, nr, srâŸ©
}

Parse â† {
  tsâ€¿numsâ€¿strs â† Tokenise ğ•©
  d  â† â‹+`(oâ†tsâˆŠ"{[")-(câ†tsâˆŠ"]}") # Closing, opening, depth
  td â† dâŠts                       # Tokens by depth
  s  â† tdâˆŠ"[{"                    # Sublist starts
  n  â† (â‹d)âŠ+`s                   # Nesting

  of â† s/'{'=td                   # Filter of subsists that are objects
  on â† +`âŠ¸Ã— of                    # Object nesting
  cl â† ':'=ts                     # Colon
  ks â† ((1+Â´of)âˆ¾Ëœ ('"'=ts)/(Â«cl)Ã—nâŠ0âˆ¾on)âŠ”strs    # Keys

  vs â† nums âˆ¾ âŠ‘ks                 # Initial values
  ln â† Â¬(Â«âŠ¸âˆ¨cl)âˆ¨oâˆ¨','=ts          # Literals and nesting
  vi â† â‹â‹ (ln/ts='0') + (2Ã—ln/ts='"') + 3Ã—ln/c   # Value indices
  vi âŠâ†© (â†•â‰ vs)âˆ¾(â‰ vs)+ â‰ âŠ¸- c/Â»n                   # Fix value indices

  Sel â† {(ğ•¨âŠ‘ks)â‰ğ•©}âŸ(0<âŠ£)          # Select
  on {vs âˆ¾â†© <ğ•¨Selğ•©âŠvs â‹„@}Â¨â—‹âŒ½ ((â‰ on)âˆ¾Ëœ1-Ëœln/n)âŠ”vi # Build result
  Â¯1âŠ‘vs
}

### Tests

O â† (âŠ‘â‰1âŠ¸âŠ‘) â‰ âŠ¸â¥ŠâŸœ0â€¿1âŠ¸âŠ” # Build an object

!(OâŸ¨"a",123,"bcde",1â€¿42â€¿30âŸ©)â‰¡ Parse"{""a"": 123, ""bcde"": [1,42,30]}"
!(OâŸ¨"a", 2âŸ©) â‰¡ Parse "{""a"": 2}"
!âŸ¨1, OâŸ¨"a",2âŸ©, 2âŸ©â‰¡ Parse "[1, {""a"": 2}, 2]"
!âŸ¨âŸ©â‰¡ Parse "[ ]"
!(2â€¿0â¥Š@)â‰¡ Parse "{}"
!(OâŸ¨"a",âŸ¨âŸ©âŸ©)â‰¡ Parse "{""a"": []}"
!âŸ¨1,2,3âŸ©â‰¡ Parse " [ 1 , 2 , 3 ] "
!âŸ¨1,âŸ¨42,âŸ¨âŸ¨0âŸ©,2,3âŸ©âŸ©,30âŸ©â‰¡ Parse "[1, [42, [[0 ], 2, 3]], 30]"
!âŸ¨1,2,âŸ¨âŸ©,âŸ¨3,4,âŸ¨5,6âŸ©âŸ©,7,8,âŸ¨9,âŸ¨âŸ©,10âŸ©âŸ©â‰¡ Parse "[1,2,[ ],[3,4,[5,6]],7,8,[9,[],10]]"
!âŸ¨1,"a",âŸ¨âŸ©,âŸ¨3,4,âŸ¨5,"b"âŸ©âŸ©,7,8,âŸ¨9,âŸ¨âŸ©,"foo"âŸ©âŸ©â‰¡ Parse "[1,""a"",[ ],[3,4,[5,""b""]],7,8,[9,[],""foo""]]"
