# Parsing a subset of JSON. The rules are:
#
# + Only integers.
# + Only ASCII in strings.
# + No constants.
# + Currently there is no input validation -- it better be valid!
#

# 'Tokenise json' yields 'tokensâ€¿numbersâ€¿strings', where 'tokens' is a string
# of characters each representing a token -- with '"' for strings and '0' for
# numbers --, 'numbers' is a list of numbers in order of occurrence, and
# 'strings' is a list of strings in order of occurrence.
#
#     Tokenise "{""a"": 123, ""bcde"": [1,42,30]}"
# âŸ¨ "{"":0,"":[0,0,0]}" âŸ¨ 123 1 42 30 âŸ© âŸ¨ "a" "bcde" âŸ© âŸ©
Tokenise â† {
  x â† (Â¬âˆŠ)âŸœ(@+10â€¿13â€¿32)âŠ¸/ğ•© # Remove whitespace
  # Numbers
  nb â† Â»âŠ¸< nâ†xâˆŠ'0'+â†•10     # Number beginnings
  numbers â† â€¢ParsefloatÂ¨ xâŠ”Ëœ 1-ËœnÃ—+`nb
  # Strings
  sb â† Â»âŠ¸< sâ†â‰ `'"'=x       # String beginnings
  strings â† xâŠ”Ëœ 1-Ëœ(s>sb)Ã—+`sb
  # Tokenise
  ts â† nbâˆ¨sbâˆ¨xâˆŠ"{}[],:"    # Tokens
  âŸ¨ '0'Â¨âŒ¾((ts/nb)âŠ¸/) ts/x
    numbers
    strings
  âŸ©
}
Tokenise "{""a"": 123, ""bcde"": [1,42,30]}"
# âŸ¨ "{"":0,"":[0,0,0]}" âŸ¨ 123 1 42 30 âŸ© âŸ¨ "a" "bcde" âŸ© âŸ©

# XXX: WIP. Only parses purely numeric lists right now.
Parse â† {
  tsâ€¿nsâ€¿ss â† Tokenise ğ•©
  oâ†ts='[' â‹„ câ†ts=']' â‹„ dâ†â‹+`(o-c)
  n â† tsâˆŠ"0]"                           # Numbers and nesting
  vi â† â‹â‹ (n/ts='0') + 2Ã—n/c            # Value indices
  l â† (â‹d)âŠ+`'['=dâŠts
  i â† viâŠ(â†•â‰ ns)âˆ¾(â‰ ns)+ â‰ âŠ¸- c/Â»l
  vs â† ns
  {vs âˆ¾â†© <ğ•©âŠvs â‹„@}Â¨ âŒ½iâŠ”Ëœ(+Â´c)âˆ¾Ëœ1-Ëœn/l
  Â¯1âŠ‘vs
}

Parse "[1, [42, [[0], 2, 3]], 30]"
# â”Œâ”€
# Â· 1 â”Œâ”€                   30
#     Â· 42 âŸ¨ âŸ¨ 0 âŸ© 2 3 âŸ©
#                        â”˜
#                             â”˜

Parse "[1,2,[3,4,[5,6]],7,8,[9,10]]"
# â”Œâ”€
# Â· 1 2 âŸ¨ 3 4 âŸ¨ 5 6 âŸ© âŸ© 7 8 âŸ¨ 9 10 âŸ©
#                                    â”˜
