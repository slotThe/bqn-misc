# A brainfuck interpreter.

P ← { # Parse
  ts ← ∊⟜"><+-[],."⊸/ 𝕩            # tokens
  ls ← (≠ts)⥊0                     # loops
  o←'['=ts ⋄ c←']'=ts ⋄ d←+`(o-c)  # depth ordering
  { ab ← ⟨𝕩, ⊑𝕩+1⊐˜(𝕩⊑d)>𝕩↓d⟩      # associate "[" with matching "]"
    ls(⌽ab)⌾(ab⊸⊏)↩ ⋄@
  }¨/o
  ts‿ls
}
P"++ > +++++ [< + > -] ++++ ++++ [< +++ +++ > -] < ."
# ⇒ ⟨ "++>+++++[<+>-]++++++++[<++++++>-]<."
#      ⟨ 0 0 0 0 0 0 0 0 13 0 0 0 0 8 0 0 0 0 0 0 0 0 32 0 0 0 0 0 0 0 0 0 22 0 0 ⟩
#    ⟩

E ← { # Execute
  ts‿ls ← P𝕩      # Tokens and loops
  a   ← 30000⥊0   # working tape
  ip  ← 0         # instruction pointer
  dp  ← 0         # data        pointer
  out ← ⟨⟩
  {𝕊·:
    { '>': dp+↩1;
      '<': dp-↩1;
      '+': a+⟜1⌾(dp⊸⊑)↩ ⋄@;
      '-': a-⟜1⌾(dp⊸⊑)↩ ⋄@;
      '.': out ∾↩ <dp⊑a ⋄@;
      '[': {𝕊0: ip↩ip⊑ls; @       }dp⊑a;
      ']': {𝕊0: @       ; ip↩ip⊑ls}dp⊑a;
      ',': {𝕊0: ip↩≠ts;        # An EOF input signals termination
             a(𝕩-@)⌾(dp⊸⊑)↩ ⋄@
           }•term.CharB@
     } ip⊑ts
     ip +↩1
   }•_while_{
     𝕊·: (ip≥0)∧(ip<≠ts)
   }@
   @+out
}

# 2 + 5
•Out E "++>+++++[<+>-]++++++++[<++++++>-]<."

# Hello World!
•Out E"++++++++[>++++[>++>+++>+++>+<<<<-]>+>+>->>+[<]<-]>>.>---.+++++++..+++.>>.<-.<.+++.------.--------.>>+."

# A quine!
•Out E"-->+++>+>+>+>+++++>++>++>->+++>++>+>>>>>>>>>>>>>>>>->++++>>>>->+++>+++>+++>+++>+ ++>+++>+>+>>>->->>++++>+>>>>->>++++>+>+>>->->++>++>++>++++>+>++>->++>++++>+>+>++ >++>->->++>++>++++>+>+>>>>>->>->>++++>++>++>++++>>>>>->>>>>+++>->++++>->->->+++> >>+>+>+++>+>++++>>+++>->>>>>->>>++++>++>++>+>+++>->++++>>->->+++>+>+++>+>++++>>> +++>->++++>>->->++>++++>++>++++>>++[-[->>+[>]++[<]<]>>+[>]<--[++>++++>]+[<]<<++] >>>[>]++++>++++[--[+>+>++++<<[-->>--<<[->-<[--->>+<<[+>+++<[+>>++<<]]]]]]>+++[>+ ++++++++++++++<-]>--.<<<]"

# An interactive Rot13
•Out (@+10)∾"Enter some text to ROT13 it (exit with EOF):"
•Out E"-,+[-[>>++++[>++++++++<-]<+<-[>+>+>-[>>>]<[[>+<-]>>+>]<<<<<-]]>>>[-]+>--[-[<->+++[-]]]<[++++++++++++<[>-[>+>>]>[+[<+>-]>+>>]<<<<<-]>>[<+>-]>[-[-<<[-]>>]<<[<<->>-]>>]<<[<<+>>-]]<[-]<.[-]<-,+]"
